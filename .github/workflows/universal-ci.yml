name: Universal CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan

jobs:
  detect-language:
    runs-on: ubuntu-latest
    outputs:
      has-python: ${{ steps.detect.outputs.has-python }}
      has-typescript: ${{ steps.detect.outputs.has-typescript }}
      has-rust: ${{ steps.detect.outputs.has-rust }}
      has-javascript: ${{ steps.detect.outputs.has-javascript }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect project languages
        id: detect
        run: |
          echo "has-python=$([ -f requirements.txt ] || [ -f pyproject.toml ] || [ -f setup.py ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-typescript=$([ -f tsconfig.json ] || [ -f package.json ] && grep -q typescript package.json && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-rust=$([ -f Cargo.toml ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-javascript=$([ -f package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  security-scan:
    runs-on: ubuntu-latest
    needs: detect-language
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Secret scanning with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  python-quality:
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.has-python == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi
      
      - name: Lint with Ruff
        run: ruff check . --output-format=github
        continue-on-error: true
      
      - name: Format check with Black
        run: black --check --diff .
        continue-on-error: true
      
      - name: Import sorting with isort
        run: isort --check-only --diff .
        continue-on-error: true
      
      - name: Security check with Bandit
        run: bandit -r . -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Safety check for dependencies
        run: safety check --json --output safety-report.json
        continue-on-error: true

  typescript-quality:
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.has-typescript == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type checking
        run: npx tsc --noEmit
        continue-on-error: true
      
      - name: Lint with ESLint
        run: npx eslint . --ext .ts,.tsx,.js,.jsx --format=github
        continue-on-error: true
      
      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  rust-quality:
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.has-rust == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt
      
      - name: Format check
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check
        continue-on-error: true
      
      - name: Clippy linting
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: -- -D warnings
        continue-on-error: true
      
      - name: Security audit
        uses: actions-rs/audit@v1
        continue-on-error: true

  dependency-update-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for outdated dependencies
        run: |
          echo "üîç Checking for outdated dependencies..."
          if [ -f requirements.txt ]; then
            echo "Python dependencies found"
            pip list --outdated || true
          fi
          if [ -f package.json ]; then
            echo "Node.js dependencies found"
            npm outdated || true
          fi
          if [ -f Cargo.toml ]; then
            echo "Rust dependencies found"
            cargo outdated || true
          fi
